## Функции, которые вызываются из-под декларации класса и что-то с ним делают

Это — очень сильное колдунство. Оно настолько сильное, что официальная
документация не описывает его никак, гугл об этом дает путанные
результаты, вопросы же на форумах ведут к закономерному «вам это
не нужно». Но если после полудня боданий вам все еще кажется, что
нужно, то читайте дальше.

Данный рецепт подходит к питонам версий выше 2.2 и ниже 3.0 (я его с
версиями 3.х просто не тестировал, увы), и содран практически
полностью с zope.interface. Зиждится он на том, что декларация
класса лежит у нас в стеке вызова функции, и найдя ее кадр в стеке,
мы получаем в распоряжение \_\_dict\_\_ класса.

    import sys
    
    def classmangler():
        frame = sys._getframe(1)
        loc = frame.f_locals
        glob = frame.f_globals
    
        # Это предохранитель. Если нас вызвали не из декларации класса,
        # надо громко ругаться.
    
        if (loc is glob) or (('__module__' not in loc) and sys.version_info[:3] > (2, 2, 0)):
            raise TypeError("Not calling from within a class declaration")
    
        # А теперь в loc можно засовывать что угодно, и это будет манипуляцией с __dict__ объявляемого класса.

Зачем это может быть нужно? Мне вот понадобился декоратор, который
обозначает явно данную функцию как публичную. Другой код,
находящийся на другой машине, может получить список таких
методов и вызывать их удаленно, допустим, используя протокол AMP.
При желании можно использовать этот подход, чтобы делать методы
приватными почти совсем как в Java (только взрываться программа
будет в рантайме).
